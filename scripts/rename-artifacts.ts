#!/usr/bin/env tsx

import * as fs from 'fs'
import * as path from 'path'

/**
 * æ„å»ºäº§ç‰©é‡å‘½åè„šæœ¬ / Build Artifacts Renaming Script
 *
 * è¯¥è„šæœ¬ç”¨äºå°† Electron Builder ç”Ÿæˆçš„é»˜è®¤æ–‡ä»¶åé‡å‘½åä¸ºç¬¦åˆé¡¹ç›®è¦æ±‚çš„æ ¼å¼
 * This script renames the default filenames generated by Electron Builder to match project requirements
 */

interface RenameRule {
  pattern: RegExp
  replacement: string
  description: string
}

// è·å–å½“å‰ç‰ˆæœ¬å· / Get current version
function getVersion(): string {
  const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'))
  return packageJson.version
}

// è·å–æ„å»ºäº§ç‰©ç›®å½• / Get build artifacts directory
function getDistDir(): string {
  return path.join(process.cwd(), 'dist')
}

// å®šä¹‰é‡å‘½åè§„åˆ™ / Define renaming rules
function getRenameRules(version: string): RenameRule[] {
  return [
    // Windows x64
    {
      pattern: /^echolab-.*-x64-setup\.exe$/,
      replacement: `echolab-${version}-x64-setup.exe`,
      description: 'Windows x64 installer'
    },
    // Windows ARM64
    {
      pattern: /^echolab-.*-arm64-setup\.exe$/,
      replacement: `echolab-${version}-arm64-setup.exe`,
      description: 'Windows ARM64 installer'
    },
    // macOS Intel (x64)
    {
      pattern: /^echolab-.*-x64\.dmg$/,
      replacement: `echolab-${version}-intel.dmg`,
      description: 'macOS Intel DMG'
    },
    // macOS Apple Silicon (arm64)
    {
      pattern: /^echolab-.*-arm64\.dmg$/,
      replacement: `echolab-${version}-arm64.dmg`,
      description: 'macOS Apple Silicon DMG'
    },
    // Linux x64 DEB (x64 -> amd64)
    {
      pattern: /^echolab-.*-x64\.deb$/,
      replacement: `echolab-${version}-amd64.deb`,
      description: 'Linux AMD64 DEB package'
    },
    // Linux x64 AppImage (x64 -> amd64)
    {
      pattern: /^echolab-.*-x64\.AppImage$/,
      replacement: `echolab-${version}-amd64.appimage`,
      description: 'Linux AMD64 AppImage'
    }
  ]
}

// é‡å‘½åæ–‡ä»¶ / Rename file
function renameFile(oldPath: string, newPath: string, description: string): void {
  try {
    if (fs.existsSync(oldPath)) {
      fs.renameSync(oldPath, newPath)
      console.log(`âœ… ${description}: ${path.basename(oldPath)} -> ${path.basename(newPath)}`)
    } else {
      console.log(`âš ï¸  File not found: ${path.basename(oldPath)}`)
    }
  } catch (error) {
    console.error(`âŒ Failed to rename ${path.basename(oldPath)}:`, error)
  }
}

// ä¸»å‡½æ•° / Main function
function main(): void {
  console.log('ğŸ”„ Starting artifact renaming process...')
  console.log('å¼€å§‹æ„å»ºäº§ç‰©é‡å‘½åè¿‡ç¨‹...\n')

  const version = getVersion()
  const distDir = getDistDir()

  console.log(`ğŸ“¦ Version: ${version}`)
  console.log(`ğŸ“ Distribution directory: ${distDir}\n`)

  if (!fs.existsSync(distDir)) {
    console.error(`âŒ Distribution directory not found: ${distDir}`)
    console.error(`âŒ æ„å»ºäº§ç‰©ç›®å½•ä¸å­˜åœ¨: ${distDir}`)
    process.exit(1)
  }

  // è·å–æ‰€æœ‰æ–‡ä»¶ / Get all files
  const files = fs.readdirSync(distDir)
  console.log('ğŸ“‹ Found files in dist directory:')
  console.log('åœ¨æ„å»ºç›®å½•ä¸­æ‰¾åˆ°çš„æ–‡ä»¶:')
  files.forEach((file) => console.log(`   - ${file}`))
  console.log()

  const renameRules = getRenameRules(version)
  let renamedCount = 0

  // åº”ç”¨é‡å‘½åè§„åˆ™ / Apply renaming rules
  for (const file of files) {
    const filePath = path.join(distDir, file)

    // è·³è¿‡ç›®å½• / Skip directories
    if (fs.statSync(filePath).isDirectory()) {
      continue
    }

    // æ£€æŸ¥æ¯ä¸ªé‡å‘½åè§„åˆ™ / Check each renaming rule
    for (const rule of renameRules) {
      if (rule.pattern.test(file)) {
        const newFileName = rule.replacement
        const newFilePath = path.join(distDir, newFileName)

        renameFile(filePath, newFilePath, rule.description)
        renamedCount++
        break // æ‰¾åˆ°åŒ¹é…è§„åˆ™åè·³å‡ºå¾ªç¯ / Break after finding a matching rule
      }
    }
  }

  console.log(`\nğŸ‰ Renaming completed! ${renamedCount} files renamed.`)
  console.log(`ğŸ‰ é‡å‘½åå®Œæˆï¼å·²é‡å‘½å ${renamedCount} ä¸ªæ–‡ä»¶ã€‚`)

  // æ˜¾ç¤ºæœ€ç»ˆæ–‡ä»¶åˆ—è¡¨ / Show final file list
  const finalFiles = fs
    .readdirSync(distDir)
    .filter((file) => fs.statSync(path.join(distDir, file)).isFile())

  console.log('\nğŸ“‹ Final artifacts:')
  console.log('æœ€ç»ˆæ„å»ºäº§ç‰©:')
  finalFiles.forEach((file) => console.log(`   - ${file}`))
}

// è¿è¡Œè„šæœ¬ / Run script
if (require.main === module) {
  main()
}

export { main as renameArtifacts }
